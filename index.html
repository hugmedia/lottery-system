<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‚ú®‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ß‡∏¢</title>

  <!-- Responsive & Fonts -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt :wght@400;500;700&display=swap');
    * {
      font-family: 'Prompt', sans-serif;
      box-sizing: border-box;
    }

    body {
      background-color: #f7f7f7;
      padding: 20px;
      margin: 0;
      font-size: 16px;
    }

    .container {
      background: #fff;
      max-width: 600px;
      margin: auto;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      font-size: 28px;
      color: #222;
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }

    button {
      padding: 10px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
    }

    .btn-green {
      background: #4CAF50;
      color: white;
      border: none;
    }
    .btn-blue {
      background: #2196F3;
      color: white;
      border: none;
    }
    .btn-delete {
      background-color: #e74c3c;
      color: white;
      border: none;
      font-size: 14px;
      padding: 8px 10px;
      height: 36px;
    }

    /* Items List */
    .items-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .item-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 14px;
      background: #f9f9f9;
      border-radius: 10px;
    }

    /* Popup */
    #popup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #ffffff;
      border-radius: 10px;
      padding: 24px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.2);
      z-index: 1000;
      text-align: center;
      width: 90vw;
      max-width: 500px;
    }

    .check-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #2ecc71;
      color: white;
      font-size: 30px;
      margin: 0 auto 15px auto;
    }

    #receipt {
      text-align: left;
      font-size: 16px;
      line-height: 1.6;
      margin-top: 10px;
      background: #ffffff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    #receipt p {
      margin: 6px 0;
      color: #333;
    }

    #receipt hr {
      border: 0;
      border-top: 1px dashed #ccc;
      margin: 15px 0;
    }

    .action-buttons {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .action-buttons button {
      width: 100%;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>‚ú®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏¢</h1>

    <div class="form-group">
      <label for="lotteryDate">‡∏á‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="lotteryDate" required>
    </div>

    <div class="form-group">
      <label for="buyerName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</label>
      <input type="text" id="buyerName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢" required>
    </div>

    <div class="items-container" id="items-container"></div>

    <button class="btn-blue" onclick="addItem()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button class="btn-green" onclick="submitAll()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <!-- Popup -->
  <div id="popup">
    <div id="receipt"></div>

    <div class="action-buttons">
      <button class="btn-blue" onclick="downloadReceipt()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
      <button class="btn-blue" onclick="shareReceipt()">‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå/‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à</button>
      <button class="btn-green" onclick="closeReceipt()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js "></script>
  <script>
    function addItem() {
      const container = document.getElementById("items-container");
      const itemDiv = document.createElement("div");
      itemDiv.className = "item-row";
      itemDiv.innerHTML = `
        <select required>
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
          <option value="2 ‡∏ï‡∏±‡∏ß (‡∏ö‡∏ô)">2 ‡∏ï‡∏±‡∏ß (‡∏ö‡∏ô)</option>
          <option value="2 ‡∏ï‡∏±‡∏ß (‡∏•‡πà‡∏≤‡∏á)">2 ‡∏ï‡∏±‡∏ß (‡∏•‡πà‡∏≤‡∏á)</option>
          <option value="3 ‡∏ï‡∏±‡∏ß‡∏´‡∏±‡∏ß (3 ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1)">3 ‡∏ï‡∏±‡∏ß‡∏´‡∏±‡∏ß (3 ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1)</option>
          <option value="3 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ (3 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1)">3 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ (3 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1)</option>
          <option value="3 ‡∏ï‡∏±‡∏ß‡πÇ‡∏ï‡πä‡∏î‡∏´‡∏±‡∏ß X3X6 (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1)">3 ‡∏ï‡∏±‡∏ß‡πÇ‡∏ï‡πä‡∏î‡∏´‡∏±‡∏ß X3X6 (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1)</option>
          <option value="3 ‡∏ï‡∏±‡∏ß‡πÇ‡∏ï‡πä‡∏î‡∏ó‡πâ‡∏≤‡∏¢ X3X6 (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1)">3 ‡∏ï‡∏±‡∏ß‡πÇ‡∏ï‡πä‡∏î‡∏ó‡πâ‡∏≤‡∏¢ X3X6 (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1)</option>
        </select>
        <input type="text" placeholder="‡πÄ‡∏•‡∏Ç" required>
        <input type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" required>
        <button class="btn-delete" onclick="removeItem(this)">‡∏•‡∏ö</button>
      `;
      container.appendChild(itemDiv);
    }

    function removeItem(btn) {
      btn.parentElement.remove();
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    function isDuplicated(number) {
      return new Set(number).size !== number.length;
    }

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏î
    function formatNumberWithMultiplier(type, number, amount) {
      if (!type.includes("‡πÇ‡∏ï‡πä‡∏î")) return number;

      const duplicated = isDuplicated(number);
      const multiplier = duplicated ? 3 : 6;
      const pricePerUnit = (amount / multiplier).toFixed(0);

      return `${number} 
        <span style="color: blue;">x${multiplier}</span> 
        <span style="color: red;">(‡∏ï‡∏±‡∏ß‡∏•‡∏∞ ${pricePerUnit} ‡∏ö‡∏≤‡∏ó)</span>`;
    }

    async function submitAll() {
      const dateInput = document.getElementById("lotteryDate").value;
      const buyerName = document.getElementById("buyerName").value;

      if (!dateInput || !buyerName) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
        return;
      }

      const thaiDate = new Date(dateInput).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'});
      const rows = document.querySelectorAll(".item-row");

      let totalAmount = 0;
      let receiptHTML = '';
      let dataToSave = [];

      try {
        rows.forEach(row => {
          const inputs = row.querySelectorAll("input, select");
          const type = inputs[0].value;
          const number = inputs[1].value.trim();
          const amount = parseFloat(inputs[2].value.trim());

          if (!type || !number || isNaN(amount)) {
            throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
          }

          totalAmount += amount;

          const formattedNumber = formatNumberWithMultiplier(type, number, amount);
          receiptHTML += `<p><strong>${type}</strong></p>`;
          receiptHTML += `<p>‡πÄ‡∏•‡∏Ç ${formattedNumber}</p>`;
          receiptHTML += `<p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${amount} ‡∏ö‡∏≤‡∏ó</p>`;
          receiptHTML += `<hr>`;
          dataToSave.push({
            date: thaiDate,
            name: buyerName,
            type,
            number,
            amount
          });
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
        const iconStyle = `
          display: flex;
          align-items: center;
          justify-content: center;
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background-color: #2ecc71;
          color: white;
          font-size: 30px;
          margin: 0 auto 15px auto;
        `;

        const headerHTML = `
          <div style="text-align:center;">
            <div style="${iconStyle}">‚úì</div>
            <h3 style="margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠!</h3>
          </div>
          <hr style="border-top: 1px dashed #ccc; margin: 20px 0;">
        `;

        const footerHTML = `
          <p style="font-weight:bold; color:#e67e22; text-align:center;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span>${totalAmount}</span> ‡∏ö‡∏≤‡∏ó</p>
          <p style="text-align:center; font-weight:normal; font-style: italic;">‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠ <span style="font-weight: normal; font-style: normal;">${buyerName}</span></p>
          <p style="color:#2ecc71; font-weight:bold; text-align:center;">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ üåü‚ú®</p>
        `;

        const fullReceiptHTML = `
          ${headerHTML}
          <p style="text-align:center;"><strong>‡∏á‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</strong> ${thaiDate}</p>
          <hr style="border-top: 1px dashed #ccc; margin: 15px 0;">
          ${receiptHTML}
          ${footerHTML}
        `;

        const receiptDiv = document.getElementById("receipt");
        receiptDiv.innerHTML = fullReceiptHTML;

        // ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets
        fetch("https://script.google.com/macros/s/AKfycbzw0nSTYw2BJOpznxLD8DNyEZDZC_b5VsuTvSz-jG3Xv-GTO8nMVCAONX1n9LFqGvlW/exec", {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(dataToSave)
        }).then(() => {
          showPopup();
        }).catch(err => {
          console.error("Error:", err);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        });

      } catch (err) {
        alert(err.message);
      }
    }

    function showPopup() {
      document.getElementById("popup").style.display = "block";
    }

    function closeReceipt() {
      document.getElementById("popup").style.display = "none";
      document.getElementById("lotteryDate").value = "";
      document.getElementById("buyerName").value = "";
      document.getElementById("items-container").innerHTML = "";
    }

    async function downloadReceipt() {
      const receiptDiv = document.getElementById("receipt");

      const canvas = await html2canvas(receiptDiv, {
        backgroundColor: "#fff",
        scale: 2
      });

      const link = document.createElement("a");
      link.download = "‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }

    function shareReceipt() {
      html2canvas(document.getElementById("receipt"), {
        backgroundColor: "#fff",
        scale: 2
      }).then(canvas => {
        canvas.toBlob(blob => {
          const file = new File([blob], "‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô.png", {type: "image/png"});
          const item = [new ClipboardItem({[file.type]: file})];

          navigator.clipboard.write(item).then(() => {
            alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î Ctrl+V ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!");
          }).catch(() => {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ó‡∏ô");
          });
        });
      });
    }
  </script>
</body>
</html>
